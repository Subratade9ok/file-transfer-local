<%- include('partials/header') %>

  <h1 class="font-bold text-xl mb-2 bg-linear-to-r from-indigo-600 to-cyan-600 text-transparent bg-clip-text">
    Browsing Files
  </h1>

  
    <div class="flex gap-x-2">
      <a href="/" class="text-indigo-600 underline">Back to Uploads</a>
      <a class="underline text-indigo-600" onclick="createFolder()" href="#">New Folder</a>
        <label
          class="underline text-indigo-600 cursor-pointer"
        >
          New File
          <input
            type="file"
            id="explorerUpload"
            multiple
            class="hidden opacity-0 absolute"
          >
        </label>

      </div>
      
      <nav class="text-sm my-3 flex flex-wrap items-center gap-1">
      <!-- Root -->
        <a href="/browse" class="text-indigo-600 ">ğŸ¡</a>

        <% if (current) { %>
          <% 
            const parts = current.split('/').filter(Boolean);
            let acc = '';
          %>

          <% parts.forEach((part, index) => { %>
            <span class="text-gray-400">â€º</span>
            <% acc += (acc ? '/' : '') + part; %>

            <% if (index === parts.length - 1) { %>
              <!-- Current folder (not a link) -->
              <span class="text-gray-400"><%= part %></span>
            <% } else { %>
              <!-- Parent folders -->
              <a
                href="/browse?path=<%= acc %>"
                class="text-indigo-700 hover:underline"
              >
                <%= part %>
              </a>
            <% } %>
          <% }) %>
        <% } %>


        <a href="/logout" class="text-xs underline text-red-600 ms-auto">Logout</a>
    </nav>


    <ul class="bg-white rounded shadow p-4">
      <% if (current && current !== '/') { %>
        <a href="/browse?path=<%= current.split('/').slice(0, -1).join('/') %>" class="text-blue-600">
        â†© Back
      </a>
      <div>&nbsp;</div>
      <% } %>
    <% if (items.length===0) { %>
      <div class="text-gray-400 h-30 flex flex-col items-center justify-center gap-y-6">
        <p class="scale-300">ğŸ“‚</p>
        <p>This folder is empty.</p>
      </div>
      <% } %>
        <% items.forEach(item=> { %>
          <li class="mb-1 flex items-center gap-x-1">
            <% if (item.isDir) { %>
              ğŸ“
              <a href="/browse?path=<%= item.path %>" class="text-blue-600 hover:underline">
                <%= item.name %>
              </a>
              <% } else { %>
                <% const ext = item.name.split('.').pop().toLowerCase(); %>
                <% const emojis = {
                  'png': 'ğŸ“·',
                  'jpg': 'ğŸ“·',
                  'jpeg': 'ğŸ“·',
                  'bmp': 'ğŸ“·',
                  'gif': 'ğŸ“¸',
                  'tiff': 'ğŸ“·',
                  'svg': 'ğŸ–¼ï¸',
                  'mp4': 'ğŸ¥',
                  'mkv': 'ğŸ¥',
                  'avi': 'ğŸ¥',
                  'mov': 'ğŸ¥',
                  'wmv': 'ğŸ¥',
                  'flv': 'ğŸ¥',
                  'mp3': 'ğŸµ',
                  'wav': 'ğŸµ',
                  'flac': 'ğŸµ',
                  'aac': 'ğŸµ',
                  'ogg': 'ğŸµ',
                  'm4a': 'ğŸµ',
                  'pdf': 'ğŸ“„',
                  'doc': 'ğŸ“„',
                  'docx': 'ğŸ“„',
                  'txt': 'ğŸ“„',
                  'rtf': 'ğŸ“„',
                  'odt': 'ğŸ“„',
                  'xls': 'ğŸ“Š',
                  'xlsx': 'ğŸ“Š',
                  'ppt': 'ğŸ“Š',
                  'pptx': 'ğŸ“Š',
                  'zip': 'ğŸ“¦',
                  'rar': 'ğŸ“¦',
                  'tar': 'ğŸ“¦',
                  'gz': 'ğŸ“¦',
                  'bz2': 'ğŸ“¦',
                  '7z': 'ğŸ“¦',
                  'exe': 'âš™ï¸',
                  'dmg': 'âš™ï¸',  
                  'bat': 'âš™ï¸',  
                  'sh': 'âš™ï¸',   
                  'html': 'ğŸŒ', 
                  'css': 'ğŸ¨',  
                  'js': 'ğŸ’»',   
                  'json': 'ğŸ’»', 
                  'xml': 'ğŸ’»',  
                  'other': 'ğŸ“'
                } %>
                <% const emoji = emojis[ext] || emojis.other; %>
                <span class="text-gray-300"><%= emoji %></span>
                <a href="/browse/download?file=<%= item.path %>" class="hover:underline hover:text-gray-800">
                  <%= item.name %>
                </a>
                <% } %>
          </li>
          <% }) %>
  </ul>



  <%- include('partials/footer') %>



  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const explorerInput = document.getElementById("explorerUpload");

      // Guard: only attach if element exists
      if (!explorerInput) return;

      explorerInput.addEventListener("change", () => {
        if (!explorerInput.files.length) return;

        const fd = new FormData();
        [...explorerInput.files].forEach(f => fd.append("files", f));

        // ğŸ”‘ current folder = upload destination
        fd.append("targetPath", "<%= current || '' %>");
        fetch(`/upload/explorer?targetPath=${encodeURIComponent("<%= current || '' %>")}`, {
          method: "POST",
          body: fd
        })
        .then(() => location.reload())
        .catch(() => alert("Upload failed"));
      });
    });



// create folder
function createFolder() {
  const name = prompt("Folder name");
  if (!name) return;

  fetch("/browse/mkdir", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      basePath: "<%= current || '' %>",
      name
    })
  })
  .then(() => location.reload())
  .catch(() => alert("Failed to create folder"));
}
</script>
